var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
	function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
	return new (P || (P = Promise))(function (resolve, reject) {
		function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
		function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
		function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
		step((generator = generator.apply(thisArg, _arguments || [])).next());
	});
};
import { ToolMode } from './tools/BezierTool.js';
import CircleTool from './tools/CircleTool.js';
import CubicTool from './tools/CubicTool.js';
import QuadTool from './tools/QuadTool.js';
export var Mode;
(function (Mode) {
	Mode[Mode["None"] = 0] = "None";
	Mode[Mode["Cube"] = 1] = "Cube";
	Mode[Mode["Quad"] = 2] = "Quad";
	Mode[Mode["Circ"] = 3] = "Circ";
})(Mode || (Mode = {}));
function unsetTool(name) {
	var _a;
	(_a = BezierControl.findTool(name, "walls")) === null || _a === void 0 ? true : delete _a.active;
	ui.controls.render();
}
const MODE_NAMES = {};
MODE_NAMES[Mode.None] = 'undefined';
MODE_NAMES[Mode.Quad] = 'bezierquad';
MODE_NAMES[Mode.Cube] = 'beziercube';
MODE_NAMES[Mode.Circ] = 'beziercirc';
const unsetters = {};
unsetters[Mode.None] = () => { };
unsetters[Mode.Quad] = () => unsetTool(MODE_NAMES[Mode.Quad]);
unsetters[Mode.Cube] = () => unsetTool(MODE_NAMES[Mode.Cube]);
unsetters[Mode.Circ] = () => unsetTool(MODE_NAMES[Mode.Circ]);
export class BezierControl {
	constructor() {
		this.inputManager = new KeyboardInputManager();
		this._mode = Mode.None;
		this.walls = [];
		this.currentHandler = null;
		this._activeTool = null;
		this._segments = 10;
	}
	get segments() { return this._segments; }
	set segments(value) {
		this._segments = Math.clamped(value, 1, 64);
		if (this.mode != Mode.None)
			this.render();
	}
	get activeTool() { return this._activeTool; }
	static get instance() {
		return this._instance || (this._instance = new this());
	}
	get mode() { return this._mode; }
	setMode(enabled, mode) {
		this.clearTool();
		if (enabled) {
			unsetters[this._mode]();
			this._mode = mode;
			this.wallsLayer.preview.sortableChildren = true;
			this.render();
		}
		else {
			if (this._mode != mode)
				return;
			this._mode = Mode.None;
			this._activeTool = null;
			this.wallsLayer.preview.sortableChildren = false;
		}
	}
	toggleCubic(enabled) {
		this.setMode(enabled, Mode.Cube);
		this._activeTool = new CubicTool();
	}
	toggleQuadratic(enabled) {
		this.setMode(enabled, Mode.Quad);
		this._activeTool = new QuadTool();
	}
	toggleCircle(enabled) {
		this.setMode(enabled, Mode.Circ);
		this._activeTool = new CircleTool();
	}
	apply() {
		return __awaiter(this, void 0, void 0, function* () {
			if (!this.activeTool || this.activeTool.mode != ToolMode.Placed)
				return;
			yield Wall.create(this.walls.map(e => e.data), {});
			this.clearTool();
		});
	}
	clearTool() {
		if (!this._activeTool)
			return;
		this._activeTool.clearTool();
		this.walls = [];
		this.wallsLayer.preview.removeChildren();
		this.render();
	}
	injectControls(controls) {
		const curveTools = [
			{
				name: MODE_NAMES[Mode.Cube],
				title: "df-curvy-walls.cubic",
				icon: 'fas fa-bezier-curve',
				onClick: (toggled) => this.toggleCubic(toggled),
				toggle: true
			},
			{
				name: MODE_NAMES[Mode.Quad],
				title: "df-curvy-walls.quadratic",
				icon: 'fas fa-project-diagram',
				onClick: (toggled) => this.toggleQuadratic(toggled),
				toggle: true
			},
			{
				name: MODE_NAMES[Mode.Circ],
				title: "df-curvy-walls.circle",
				icon: 'fas fa-circle',
				onClick: (toggled) => this.toggleCircle(toggled),
				toggle: true
			}
		];
		const tools = controls.find(e => e.name === 'walls').tools;
		tools.splice(tools.findIndex(e => e.name === 'clone') + 1, 0, ...curveTools);
		// We are only called when we first load, or if the user left and came back
		// Clear all of our state when that happens
		this._mode = Mode.None;
		this._activeTool = null;
		this.walls = [];
	}
	static _onDragLeftStart(event) {
		const self = BezierControl.instance;
		if (self.mode == Mode.None || self.activeTool == null)
			return self.wallsLayer.dfWallCurves_onDragLeftStart(event);
		self.currentHandler = self.activeTool.checkPointForDrag(event.data.origin);
		if (self.currentHandler == null)
			return;
		self.currentHandler.start(event.data.origin, event.data.destination, event);
		self.render();
	}
	static _onDragLeftMove(event) {
		const self = BezierControl.instance;
		if (self.mode == Mode.None || !self.currentHandler)
			return self.wallsLayer.dfWallCurves_onDragLeftMove(event);
		self.currentHandler.move(event.data.origin, event.data.destination, event);
		self.render();
	}
	static _onDragLeftDrop(event) {
		const self = BezierControl.instance;
		if (self.mode == Mode.None || !self.currentHandler)
			return self.wallsLayer.dfWallCurves_onDragLeftDrop(event);
		self.currentHandler.stop(event.data.origin, event.data.destination, event);
		self.currentHandler = null;
		self.render();
	}
	static _onDragLeftCancel(event) {
		const self = BezierControl.instance;
		if (self.mode == Mode.None)
			return self.wallsLayer.dfWallCurves_onDragLeftCancel(event);
		else if (!self.currentHandler)
			return;
		self.currentHandler.cancel();
		self.currentHandler = null;
		self.render();
	}
	render() {
		var _a;
		this.wallsLayer.preview.removeChildren();
		if (this.activeTool == null)
			return;
		const points = (_a = this.activeTool) === null || _a === void 0 ? void 0 : _a.getSegments(this.segments);
		if (points.length == 0)
			return;
		this.walls.length;
		const wallData = this.wallsLayer._getWallDataFromActiveTool(game.activeTool);
		while (this.walls.length > points.length - 1) {
			const wall = this.walls.pop();
			this.wallsLayer.preview.removeChild(wall);
		}
		for (var c = 0; c < points.length - 1; c++) {
			const data = duplicate(wallData);
			data.c = [points[c].x, points[c].y, points[c + 1].x, points[c + 1].y];
			if (c == this.walls.length) {
				this.walls.push(new Wall(data, undefined));
				this.wallsLayer.preview.addChild(this.walls[c]);
				this.walls[c].draw();
			}
			else {
				this.walls[c].data = data;
				this.wallsLayer.preview.addChild(this.walls[c]);
				this.walls[c].refresh();
			}
		}
		const graphics = new PIXI.Graphics(null);
		this.wallsLayer.preview.addChild(graphics);
		this.activeTool.drawHandles(graphics);
	}
	patchWallsLayer() {
		const layer = canvas.getLayer("WallsLayer");
		this.wallsLayer = layer;
		this.wallsLayer.dfWallCurves_onDragLeftStart = this.wallsLayer._onDragLeftStart;
		this.wallsLayer.dfWallCurves_onDragLeftMove = this.wallsLayer._onDragLeftMove;
		this.wallsLayer.dfWallCurves_onDragLeftDrop = this.wallsLayer._onDragLeftDrop;
		this.wallsLayer.dfWallCurves_onDragLeftCancel = this.wallsLayer._onDragLeftCancel;
		this.wallsLayer._onDragLeftStart = BezierControl._onDragLeftStart;
		this.wallsLayer._onDragLeftMove = BezierControl._onDragLeftMove;
		this.wallsLayer._onDragLeftDrop = BezierControl._onDragLeftDrop;
		this.wallsLayer._onDragLeftCancel = BezierControl._onDragLeftCancel;
		window.addEventListener('keydown', this.inputManager.onKeyDown.bind(this.inputManager));
		window.addEventListener('keyup', this.inputManager.onKeyUp.bind(this.inputManager));
		Hooks.on('requestCurvyWallsRedraw', () => {
			this.render();
		});
	}
	static findControl(name) {
		return ui.controls.controls.find(e => e.name === name);
	}
	static findTool(name, control) {
		if (control != undefined)
			return ui.controls.controls.find(e => e.name === control).tools.find(e => e.name === name);
		for (var c = 0; c < ui.controls.controls.length; c++) {
			const control = ui.controls.controls[c];
			const tool = control.tools.find(e => e.name === name);
			if (tool != undefined)
				return tool;
		}
		return undefined;
	}
}
class KeyboardInputManager {
	constructor() {
		this._currentKeys = new Set();
	}
	onKeyDown(event) {
		const key = game.keyboard.getKey(event);
		if (key in ["Enter", "Delete", "Backspace", "-", "="])
			return;
		if (this._currentKeys.size == 0)
			return;
		this._currentKeys.add(key);
	}
	onKeyUp(event) {
		const key = game.keyboard.getKey(event);
		if (key in this._currentKeys)
			return;
		event.preventDefault();
		switch (key) {
			case "Enter":
				BezierControl.instance.apply();
				break;
			case "Delete":
			case "Backspace":
				BezierControl.instance.clearTool();
				break;
			case "-":
				BezierControl.instance.segments--;
				break;
			case "=":
				BezierControl.instance.segments++;
				break;
		}
		this._currentKeys.clear();
	}
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2RmLWN1cnZ5LXdhbGxzL3NyYy9CZXppZXJDb250cm9sLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUNBLE9BQU8sRUFBYyxRQUFRLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUM3RCxPQUFPLFVBQVUsTUFBTSx1QkFBdUIsQ0FBQztBQUMvQyxPQUFPLFNBQVMsTUFBTSxzQkFBc0IsQ0FBQztBQUM3QyxPQUFPLFFBQVEsTUFBTSxxQkFBcUIsQ0FBQztBQWtCM0MsTUFBTSxDQUFOLElBQVksSUFLWDtBQUxELFdBQVksSUFBSTtJQUNmLCtCQUFJLENBQUE7SUFDSiwrQkFBSSxDQUFBO0lBQ0osK0JBQUksQ0FBQTtJQUNKLCtCQUFJLENBQUE7QUFDTCxDQUFDLEVBTFcsSUFBSSxLQUFKLElBQUksUUFLZjtBQUVELFNBQVMsU0FBUyxDQUFDLElBQVk7O0lBQ3ZCLE1BQUEsYUFBYSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLCtDQUFFLE1BQU0sQ0FBQztJQUNyRCxFQUFFLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBQ3RCLENBQUM7QUFDRCxNQUFNLFVBQVUsR0FBOEIsRUFBRSxDQUFDO0FBQ2pELFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsV0FBVyxDQUFDO0FBQ3BDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsWUFBWSxDQUFDO0FBQ3JDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsWUFBWSxDQUFDO0FBQ3JDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsWUFBWSxDQUFDO0FBQ3JDLE1BQU0sU0FBUyxHQUFnQyxFQUFFLENBQUM7QUFDbEQsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUE7QUFDaEMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FB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UCxLQUFLLEdBQUc7Z0JBQ1AsYUFBYSxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsQ0FBQztnQkFDbEMsTUFBTTtTQUNQO1FBQ0QsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUMzQixDQUFDO0NBQ0QiLCJmaWxlIjoiQmV6aWVyQ29udHJvbC5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxuaW1wb3J0IHsgQmV6aWVyVG9vbCwgVG9vbE1vZGUgfSBmcm9tICcuL3Rvb2xzL0JlemllclRvb2wuanMnO1xuaW1wb3J0IENpcmNsZVRvb2wgZnJvbSAnLi90b29scy9DaXJjbGVUb29sLmpzJztcbmltcG9ydCBDdWJpY1Rvb2wgZnJvbSAnLi90b29scy9DdWJpY1Rvb2wuanMnO1xuaW1wb3J0IFF1YWRUb29sIGZyb20gJy4vdG9vbHMvUXVhZFRvb2wuanMnO1xuaW1wb3J0IHsgSW5wdXRIYW5kbGVyIH0gZnJvbSAnLi90b29scy9Ub29sSW5wdXRIYW5kbGVyLmpzJztcblxuZGVjbGFyZSBnbG9iYWwge1xuXHRpbnRlcmZhY2UgV2FsbHNMYXllciB7XG5cdFx0ZGZXYWxsQ3VydmVzX29uRHJhZ0xlZnRTdGFydChldmVudDogUElYSS5JbnRlcmFjdGlvbkV2ZW50KTogdm9pZFxuXHRcdGRmV2FsbEN1cnZlc19vbkRyYWdMZWZ0TW92ZShldmVudDogUElYSS5JbnRlcmFjdGlvbkV2ZW50KTogdm9pZFxuXHRcdGRmV2FsbEN1cnZlc19vbkRyYWdMZWZ0RHJvcChldmVudDogUElYSS5JbnRlcmFjdGlvbkV2ZW50KTogdm9pZFxuXHRcdGRmV2FsbEN1cnZlc19vbkRyYWdMZWZ0Q2FuY2VsKGV2ZW50OiBQSVhJLkludGVyYWN0aW9uRXZlbnQpOiB2b2lkXG5cdH1cblx0bmFtZXNwYWNlIFBJWEkge1xuXHRcdGludGVyZmFjZSBJbnRlcmFjdGlvbkRhdGEge1xuXHRcdFx0b3JpZ2luOiBQSVhJLlBvaW50O1xuXHRcdFx0ZGVzdGluYXRpb246IFBJWEkuUG9pbnQ7XG5cdFx0fVxuXHR9XG59XG5cbmV4cG9ydCBlbnVtIE1vZGUge1xuXHROb25lLFxuXHRDdWJlLFxuXHRRdWFkLFxuXHRDaXJjXG59XG5cbmZ1bmN0aW9uIHVuc2V0VG9vbChuYW1lOiBzdHJpbmcpIHtcblx0ZGVsZXRlIEJlemllckNvbnRyb2wuZmluZFRvb2wobmFtZSwgXCJ3YWxsc1wiKT8uYWN0aXZlO1xuXHR1aS5jb250cm9scy5yZW5kZXIoKTtcbn1cbmNvbnN0IE1PREVfTkFNRVM6IHsgW2tleTogbnVtYmVyXTogc3RyaW5nIH0gPSB7fTtcbk1PREVfTkFNRVNbTW9kZS5Ob25lXSA9ICd1bmRlZmluZWQnO1xuTU9ERV9OQU1FU1tNb2RlLlF1YWRdID0gJ2JlemllcnF1YWQnO1xuTU9ERV9OQU1FU1tNb2RlLkN1YmVdID0gJ2JlemllcmN1YmUnO1xuTU9ERV9OQU1FU1tNb2RlLkNpcmNdID0gJ2JlemllcmNpcmMnO1xuY29uc3QgdW5zZXR0ZXJzOiB7IFtrZXk6IG51bWJlcl06IEZ1bmN0aW9uIH0gPSB7fTtcbnVuc2V0dGVyc1tNb2RlLk5vbmVdID0gKCkgPT4geyB9XG51bnNldHRlcnNbTW9kZS5RdWFkXSA9ICgpID0+IHVuc2V0VG9vbChNT0RFX05BTUVTW01vZGUuUXVhZF0pO1xudW5zZXR0ZXJzW01vZGUuQ3ViZV0gPSAoKSA9PiB1bnNldFRvb2woTU9ERV9OQU1FU1tNb2RlLkN1YmVdKTtcbnVuc2V0dGVyc1tNb2RlLkNpcmNdID0gKCkgPT4gdW5zZXRUb29sKE1PREVfTkFNRVNbTW9kZS5DaXJjXSk7XG5cbmV4cG9ydCBjbGFzcyBCZXppZXJDb250cm9sIHtcblx0cHJpdmF0ZSBzdGF0aWMgX2luc3RhbmNlOiBCZXppZXJDb250cm9sO1xuXHRwcml2YXRlIGlucHV0TWFuYWdlciA9IG5ldyBLZXlib2FyZElucHV0TWFuYWdlcigpO1xuXHRwcml2YXRlIF9tb2RlID0gTW9kZS5Ob25lO1xuXHRwcml2YXRlIHdhbGxzTGF5ZXI6IFdhbGxzTGF5ZXI7XG5cdHByaXZhdGUgd2FsbHM6IFdhbGxbXSA9IFtdO1xuXHRwcml2YXRlIGN1cnJlbnRIYW5kbGVyPzogSW5wdXRIYW5kbGVyID0gbnVsbDtcblx0cHJpdmF0ZSBfYWN0aXZlVG9vbD86IEJlemllclRvb2wgPSBudWxsO1xuXHRwcml2YXRlIF9zZWdtZW50cyA9IDEwO1xuXHRnZXQgc2VnbWVudHMoKTogbnVtYmVyIHsgcmV0dXJuIHRoaXMuX3NlZ21lbnRzOyB9XG5cdHNldCBzZWdtZW50cyh2YWx1ZTogbnVtYmVyKSB7XG5cdFx0dGhpcy5fc2VnbWVudHMgPSBNYXRoLmNsYW1wZWQodmFsdWUsIDEsIDY0KTtcblx0XHRpZiAodGhpcy5tb2RlICE9IE1vZGUuTm9uZSlcblx0XHRcdHRoaXMucmVuZGVyKCk7XG5cdH1cblx0Z2V0IGFjdGl2ZVRvb2woKTogQmV6aWVyVG9vbCB8IG51bGwgeyByZXR1cm4gdGhpcy5fYWN0aXZlVG9vbDsgfVxuXG5cdHByaXZhdGUgY29uc3RydWN0b3IoKSB7IH1cblx0cHVibGljIHN0YXRpYyBnZXQgaW5zdGFuY2UoKTogQmV6aWVyQ29udHJvbCB7XG5cdFx0cmV0dXJuIHRoaXMuX2luc3RhbmNlIHx8ICh0aGlzLl9pbnN0YW5jZSA9IG5ldyB0aGlzKCkpO1xuXHR9XG5cblx0Z2V0IG1vZGUoKTogTW9kZSB7IHJldHVybiB0aGlzLl9tb2RlOyB9XG5cblx0cHJpdmF0ZSBzZXRNb2RlKGVuYWJsZWQ6IGJvb2xlYW4sIG1vZGU6IE1vZGUpIHtcblx0XHR0aGlzLmNsZWFyVG9vbCgpXG5cdFx0aWYgKGVuYWJsZWQpIHtcblx0XHRcdHVuc2V0dGVyc1t0aGlzLl9tb2RlXSgpO1xuXHRcdFx0dGhpcy5fbW9kZSA9IG1vZGU7XG5cdFx0XHR0aGlzLndhbGxzTGF5ZXIucHJldmlldy5zb3J0YWJsZUNoaWxkcmVuID0gdHJ1ZTtcblx0XHRcdHRoaXMucmVuZGVyKCk7XG5cdFx0fVxuXHRcdGVsc2Uge1xuXHRcdFx0aWYgKHRoaXMuX21vZGUgIT0gbW9kZSkgcmV0dXJuO1xuXHRcdFx0dGhpcy5fbW9kZSA9IE1vZGUuTm9uZVxuXHRcdFx0dGhpcy5fYWN0aXZlVG9vbCA9IG51bGw7XG5cdFx0XHR0aGlzLndhbGxzTGF5ZXIucHJldmlldy5zb3J0YWJsZUNoaWxkcmVuID0gZmFsc2U7XG5cdFx0fVxuXHR9XG5cblx0dG9nZ2xlQ3ViaWMoZW5hYmxlZDogYm9vbGVhbikge1xuXHRcdHRoaXMuc2V0TW9kZShlbmFibGVkLCBNb2RlLkN1YmUpO1xuXHRcdHRoaXMuX2FjdGl2ZVRvb2wgPSBuZXcgQ3ViaWNUb29sKCk7XG5cdH1cblx0dG9nZ2xlUXVhZHJhdGljKGVuYWJsZWQ6IGJvb2xlYW4pIHtcblx0XHR0aGlzLnNldE1vZGUoZW5hYmxlZCwgTW9kZS5RdWFkKTtcblx0XHR0aGlzLl9hY3RpdmVUb29sID0gbmV3IFF1YWRUb29sKCk7XG5cdH1cblx0dG9nZ2xlQ2lyY2xlKGVuYWJsZWQ6IGJvb2xlYW4pIHtcblx0XHR0aGlzLnNldE1vZGUoZW5hYmxlZCwgTW9kZS5DaXJjKTtcblx0XHR0aGlzLl9hY3RpdmVUb29sID0gbmV3IENpcmNsZVRvb2woKTtcblx0fVxuXG5cdGFzeW5jIGFwcGx5KCkge1xuXHRcdGlmICghdGhpcy5hY3RpdmVUb29sIHx8IHRoaXMuYWN0aXZlVG9vbC5tb2RlICE9IFRvb2xNb2RlLlBsYWNlZCkgcmV0dXJuO1xuXHRcdGF3YWl0IFdhbGwuY3JlYXRlKHRoaXMud2FsbHMubWFwKGUgPT4gZS5kYXRhKSwge30pO1xuXHRcdHRoaXMuY2xlYXJUb29sKCk7XG5cdH1cblxuXHRjbGVhclRvb2woKSB7XG5cdFx0aWYgKCF0aGlzLl9hY3RpdmVUb29sKSByZXR1cm47XG5cdFx0dGhpcy5fYWN0aXZlVG9vbC5jbGVhclRvb2woKTtcblx0XHR0aGlzLndhbGxzID0gW107XG5cdFx0dGhpcy53YWxsc0xheWVyLnByZXZpZXcucmVtb3ZlQ2hpbGRyZW4oKTtcblx0XHR0aGlzLnJlbmRlcigpO1xuXHR9XG5cblx0aW5qZWN0Q29udHJvbHMoY29udHJvbHM6IFNjZW5lQ29udHJvbFtdKSB7XG5cdFx0Y29uc3QgY3VydmVUb29sczogU2NlbmVDb250cm9sVG9vbFtdID0gW1xuXHRcdFx0e1xuXHRcdFx0XHRuYW1lOiBNT0RFX05BTUVTW01vZGUuQ3ViZV0sXG5cdFx0XHRcdHRpdGxlOiBcImRmLWN1cnZ5LXdhbGxzLmN1YmljXCIsXG5cdFx0XHRcdGljb246ICdmYXMgZmEtYmV6aWVyLWN1cnZlJyxcblx0XHRcdFx0b25DbGljazogKHRvZ2dsZWQ6IGJvb2xlYW4pID0+IHRoaXMudG9nZ2xlQ3ViaWModG9nZ2xlZCksXG5cdFx0XHRcdHRvZ2dsZTogdHJ1ZVxuXHRcdFx0fSxcblx0XHRcdHtcblx0XHRcdFx0bmFtZTogTU9ERV9OQU1FU1tNb2RlLlF1YWRdLFxuXHRcdFx0XHR0aXRsZTogXCJkZi1jdXJ2eS13YWxscy5xdWFkcmF0aWNcIixcblx0XHRcdFx0aWNvbjogJ2ZhcyBmYS1wcm9qZWN0LWRpYWdyYW0nLFxuXHRcdFx0XHRvbkNsaWNrOiAodG9nZ2xlZDogYm9vbGVhbikgPT4gdGhpcy50b2dnbGVRdWFkcmF0aWModG9nZ2xlZCksXG5cdFx0XHRcdHRvZ2dsZTogdHJ1ZVxuXHRcdFx0fSxcblx0XHRcdHtcblx0XHRcdFx0bmFtZTogTU9ERV9OQU1FU1tNb2RlLkNpcmNdLFxuXHRcdFx0XHR0aXRsZTogXCJkZi1jdXJ2eS13YWxscy5jaXJjbGVcIixcblx0XHRcdFx0aWNvbjogJ2ZhcyBmYS1jaXJjbGUnLFxuXHRcdFx0XHRvbkNsaWNrOiAodG9nZ2xlZDogYm9vbGVhbikgPT4gdGhpcy50b2dnbGVDaXJjbGUodG9nZ2xlZCksXG5cdFx0XHRcdHRvZ2dsZTogdHJ1ZVxuXHRcdFx0fVxuXHRcdF07XG5cdFx0Y29uc3QgdG9vbHMgPSBjb250cm9scy5maW5kKGUgPT4gZS5uYW1lID09PSAnd2FsbHMnKS50b29scztcblx0XHR0b29scy5zcGxpY2UodG9vbHMuZmluZEluZGV4KGUgPT4gZS5uYW1lID09PSAnY2xvbmUnKSArIDEsIDAsIC4uLmN1cnZlVG9vbHMpO1xuXG5cdFx0Ly8gV2UgYXJlIG9ubHkgY2FsbGVkIHdoZW4gd2UgZmlyc3QgbG9hZCwgb3IgaWYgdGhlIHVzZXIgbGVmdCBhbmQgY2FtZSBiYWNrXG5cdFx0Ly8gQ2xlYXIgYWxsIG9mIG91ciBzdGF0ZSB3aGVuIHRoYXQgaGFwcGVuc1xuXHRcdHRoaXMuX21vZGUgPSBNb2RlLk5vbmVcblx0XHR0aGlzLl9hY3RpdmVUb29sID0gbnVsbDtcblx0XHR0aGlzLndhbGxzID0gW107XG5cdH1cblxuXHRzdGF0aWMgX29uRHJhZ0xlZnRTdGFydChldmVudDogUElYSS5JbnRlcmFjdGlvbkV2ZW50KSB7XG5cdFx0Y29uc3Qgc2VsZiA9IEJlemllckNvbnRyb2wuaW5zdGFuY2U7XG5cdFx0aWYgKHNlbGYubW9kZSA9PSBNb2RlLk5vbmUgfHwgc2VsZi5hY3RpdmVUb29sID09IG51bGwpIHJldHVybiBzZWxmLndhbGxzTGF5ZXIuZGZXYWxsQ3VydmVzX29uRHJhZ0xlZnRTdGFydChldmVudCk7XG5cdFx0c2VsZi5jdXJyZW50SGFuZGxlciA9IHNlbGYuYWN0aXZlVG9vbC5jaGVja1BvaW50Rm9yRHJhZyhldmVudC5kYXRhLm9yaWdpbik7XG5cdFx0aWYgKHNlbGYuY3VycmVudEhhbmRsZXIgPT0gbnVsbCkgcmV0dXJuO1xuXHRcdHNlbGYuY3VycmVudEhhbmRsZXIuc3RhcnQoZXZlbnQuZGF0YS5vcmlnaW4sIGV2ZW50LmRhdGEuZGVzdGluYXRpb24sIGV2ZW50KTtcblx0XHRzZWxmLnJlbmRlcigpO1xuXHR9XG5cdHN0YXRpYyBfb25EcmFnTGVmdE1vdmUoZXZlbnQ6IFBJWEkuSW50ZXJhY3Rpb25FdmVudCkge1xuXHRcdGNvbnN0IHNlbGYgPSBCZXppZXJDb250cm9sLmluc3RhbmNlO1xuXHRcdGlmIChzZWxmLm1vZGUgPT0gTW9kZS5Ob25lIHx8ICFzZWxmLmN1cnJlbnRIYW5kbGVyKSByZXR1cm4gc2VsZi53YWxsc0xheWVyLmRmV2FsbEN1cnZlc19vbkRyYWdMZWZ0TW92ZShldmVudCk7XG5cdFx0c2VsZi5jdXJyZW50SGFuZGxlci5tb3ZlKGV2ZW50LmRhdGEub3JpZ2luLCBldmVudC5kYXRhLmRlc3RpbmF0aW9uLCBldmVudCk7XG5cdFx0c2VsZi5yZW5kZXIoKTtcblx0fVxuXHRzdGF0aWMgX29uRHJhZ0xlZnREcm9wKGV2ZW50OiBQSVhJLkludGVyYWN0aW9uRXZlbnQpIHtcblx0XHRjb25zdCBzZWxmID0gQmV6aWVyQ29udHJvbC5pbnN0YW5jZTtcblx0XHRpZiAoc2VsZi5tb2RlID09IE1vZGUuTm9uZSB8fCAhc2VsZi5jdXJyZW50SGFuZGxlcikgcmV0dXJuIHNlbGYud2FsbHNMYXllci5kZldhbGxDdXJ2ZXNfb25EcmFnTGVmdERyb3AoZXZlbnQpO1xuXHRcdHNlbGYuY3VycmVudEhhbmRsZXIuc3RvcChldmVudC5kYXRhLm9yaWdpbiwgZXZlbnQuZGF0YS5kZXN0aW5hdGlvbiwgZXZlbnQpO1xuXHRcdHNlbGYuY3VycmVudEhhbmRsZXIgPSBudWxsO1xuXHRcdHNlbGYucmVuZGVyKCk7XG5cdH1cblx0c3RhdGljIF9vbkRyYWdMZWZ0Q2FuY2VsKGV2ZW50OiBQSVhJLkludGVyYWN0aW9uRXZlbnQpIHtcblx0XHRjb25zdCBzZWxmID0gQmV6aWVyQ29udHJvbC5pbnN0YW5jZTtcblx0XHRpZiAoc2VsZi5tb2RlID09IE1vZGUuTm9uZSkgcmV0dXJuIHNlbGYud2FsbHNMYXllci5kZldhbGxDdXJ2ZXNfb25EcmFnTGVmdENhbmNlbChldmVudCk7XG5cdFx0ZWxzZSBpZiAoIXNlbGYuY3VycmVudEhhbmRsZXIpIHJldHVybjtcblx0XHRzZWxmLmN1cnJlbnRIYW5kbGVyLmNhbmNlbCgpO1xuXHRcdHNlbGYuY3VycmVudEhhbmRsZXIgPSBudWxsO1xuXHRcdHNlbGYucmVuZGVyKCk7XG5cdH1cblxuXHRyZW5kZXIoKSB7XG5cdFx0dGhpcy53YWxsc0xheWVyLnByZXZpZXcucmVtb3ZlQ2hpbGRyZW4oKTtcblx0XHRpZiAodGhpcy5hY3RpdmVUb29sID09IG51bGwpIHJldHVybjtcblx0XHRjb25zdCBwb2ludHMgPSB0aGlzLmFjdGl2ZVRvb2w/LmdldFNlZ21lbnRzKHRoaXMuc2VnbWVudHMpO1xuXHRcdGlmIChwb2ludHMubGVuZ3RoID09IDApIHJldHVybjtcblx0XHR0aGlzLndhbGxzLmxlbmd0aFxuXHRcdGNvbnN0IHdhbGxEYXRhID0gKDxhbnk+dGhpcy53YWxsc0xheWVyKS5fZ2V0V2FsbERhdGFGcm9tQWN0aXZlVG9vbChnYW1lLmFjdGl2ZVRvb2wpO1xuXG5cdFx0d2hpbGUgKHRoaXMud2FsbHMubGVuZ3RoID4gcG9pbnRzLmxlbmd0aCAtIDEpIHtcblx0XHRcdGNvbnN0IHdhbGwgPSB0aGlzLndhbGxzLnBvcCgpO1xuXHRcdFx0dGhpcy53YWxsc0xheWVyLnByZXZpZXcucmVtb3ZlQ2hpbGQod2FsbCk7XG5cdFx0fVxuXHRcdGZvciAodmFyIGMgPSAwOyBjIDwgcG9pbnRzLmxlbmd0aCAtIDE7IGMrKykge1xuXHRcdFx0Y29uc3QgZGF0YSA9IGR1cGxpY2F0ZSh3YWxsRGF0YSk7XG5cdFx0XHRkYXRhLmMgPSBbcG9pbnRzW2NdLngsIHBvaW50c1tjXS55LCBwb2ludHNbYyArIDFdLngsIHBvaW50c1tjICsgMV0ueV1cblx0XHRcdGlmIChjID09IHRoaXMud2FsbHMubGVuZ3RoKSB7XG5cdFx0XHRcdHRoaXMud2FsbHMucHVzaChuZXcgV2FsbChkYXRhLCB1bmRlZmluZWQpKTtcblx0XHRcdFx0dGhpcy53YWxsc0xheWVyLnByZXZpZXcuYWRkQ2hpbGQodGhpcy53YWxsc1tjXSk7XG5cdFx0XHRcdHRoaXMud2FsbHNbY10uZHJhdygpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0dGhpcy53YWxsc1tjXS5kYXRhID0gZGF0YTtcblx0XHRcdFx0dGhpcy53YWxsc0xheWVyLnByZXZpZXcuYWRkQ2hpbGQodGhpcy53YWxsc1tjXSk7XG5cdFx0XHRcdHRoaXMud2FsbHNbY10ucmVmcmVzaCgpO1xuXHRcdFx0fVxuXHRcdH1cblx0XHRjb25zdCBncmFwaGljcyA9IG5ldyBQSVhJLkdyYXBoaWNzKG51bGwpO1xuXHRcdHRoaXMud2FsbHNMYXllci5wcmV2aWV3LmFkZENoaWxkKGdyYXBoaWNzKTtcblx0XHR0aGlzLmFjdGl2ZVRvb2wuZHJhd0hhbmRsZXMoZ3JhcGhpY3MpO1xuXHR9XG5cblx0cGF0Y2hXYWxsc0xheWVyKCkge1xuXHRcdGNvbnN0IGxheWVyID0gKDxDYW52YXM+Y2FudmFzKS5nZXRMYXllcihcIldhbGxzTGF5ZXJcIik7XG5cdFx0dGhpcy53YWxsc0xheWVyID0gbGF5ZXIgYXMgV2FsbHNMYXllcjtcblx0XHR0aGlzLndhbGxzTGF5ZXIuZGZXYWxsQ3VydmVzX29uRHJhZ0xlZnRTdGFydCA9ICg8YW55PnRoaXMud2FsbHNMYXllcikuX29uRHJhZ0xlZnRTdGFydDtcblx0XHR0aGlzLndhbGxzTGF5ZXIuZGZXYWxsQ3VydmVzX29uRHJhZ0xlZnRNb3ZlID0gKDxhbnk+dGhpcy53YWxsc0xheWVyKS5fb25EcmFnTGVmdE1vdmU7XG5cdFx0dGhpcy53YWxsc0xheWVyLmRmV2FsbEN1cnZlc19vbkRyYWdMZWZ0RHJvcCA9ICg8YW55PnRoaXMud2FsbHNMYXllcikuX29uRHJhZ0xlZnREcm9wO1xuXHRcdHRoaXMud2FsbHNMYXllci5kZldhbGxDdXJ2ZXNfb25EcmFnTGVmdENhbmNlbCA9ICg8YW55PnRoaXMud2FsbHNMYXllcikuX29uRHJhZ0xlZnRDYW5jZWw7XG5cdFx0KDxhbnk+dGhpcy53YWxsc0xheWVyKS5fb25EcmFnTGVmdFN0YXJ0ID0gQmV6aWVyQ29udHJvbC5fb25EcmFnTGVmdFN0YXJ0O1xuXHRcdCg8YW55PnRoaXMud2FsbHNMYXllcikuX29uRHJhZ0xlZnRNb3ZlID0gQmV6aWVyQ29udHJvbC5fb25EcmFnTGVmdE1vdmU7XG5cdFx0KDxhbnk+dGhpcy53YWxsc0xheWVyKS5fb25EcmFnTGVmdERyb3AgPSBCZXppZXJDb250cm9sLl9vbkRyYWdMZWZ0RHJvcDtcblx0XHQoPGFueT50aGlzLndhbGxzTGF5ZXIpLl9vbkRyYWdMZWZ0Q2FuY2VsID0gQmV6aWVyQ29udHJvbC5fb25EcmFnTGVmdENhbmNlbDtcblx0XHR3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIHRoaXMuaW5wdXRNYW5hZ2VyLm9uS2V5RG93bi5iaW5kKHRoaXMuaW5wdXRNYW5hZ2VyKSk7XG5cdFx0d2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2tleXVwJywgdGhpcy5pbnB1dE1hbmFnZXIub25LZXlVcC5iaW5kKHRoaXMuaW5wdXRNYW5hZ2VyKSk7XG5cdFx0SG9va3Mub24oJ3JlcXVlc3RDdXJ2eVdhbGxzUmVkcmF3JywgKCkgPT4ge1xuXHRcdFx0dGhpcy5yZW5kZXIoKTtcblx0XHR9KTtcblx0fVxuXG5cdHN0YXRpYyBmaW5kQ29udHJvbChuYW1lOiBzdHJpbmcpOiBTY2VuZUNvbnRyb2wgfCB1bmRlZmluZWQge1xuXHRcdHJldHVybiB1aS5jb250cm9scy5jb250cm9scy5maW5kKGUgPT4gZS5uYW1lID09PSBuYW1lKTtcblx0fVxuXHRzdGF0aWMgZmluZFRvb2wobmFtZTogc3RyaW5nLCBjb250cm9sPzogc3RyaW5nKTogU2NlbmVDb250cm9sVG9vbCB8IHVuZGVmaW5lZCB7XG5cdFx0aWYgKGNvbnRyb2wgIT0gdW5kZWZpbmVkKVxuXHRcdFx0cmV0dXJuIHVpLmNvbnRyb2xzLmNvbnRyb2xzLmZpbmQoZSA9PiBlLm5hbWUgPT09IGNvbnRyb2wpLnRvb2xzLmZpbmQoZSA9PiBlLm5hbWUgPT09IG5hbWUpO1xuXHRcdGZvciAodmFyIGMgPSAwOyBjIDwgdWkuY29udHJvbHMuY29udHJvbHMubGVuZ3RoOyBjKyspIHtcblx0XHRcdGNvbnN0IGNvbnRyb2wgPSB1aS5jb250cm9scy5jb250cm9sc1tjXTtcblx0XHRcdGNvbnN0IHRvb2wgPSBjb250cm9sLnRvb2xzLmZpbmQoZSA9PiBlLm5hbWUgPT09IG5hbWUpO1xuXHRcdFx0aWYgKHRvb2wgIT0gdW5kZWZpbmVkKSByZXR1cm4gdG9vbDtcblx0XHR9XG5cdFx0cmV0dXJuIHVuZGVmaW5lZDtcblx0fVxufVxuXG5jbGFzcyBLZXlib2FyZElucHV0TWFuYWdlciB7XG5cdHByaXZhdGUgX2N1cnJlbnRLZXlzID0gbmV3IFNldDxzdHJpbmc+KClcblx0b25LZXlEb3duKGV2ZW50OiBLZXlib2FyZEV2ZW50KSB7XG5cdFx0Y29uc3Qga2V5ID0gZ2FtZS5rZXlib2FyZC5nZXRLZXkoZXZlbnQpO1xuXHRcdGlmIChrZXkhIGluIFtcIkVudGVyXCIsIFwiRGVsZXRlXCIsIFwiQmFja3NwYWNlXCIsIFwiLVwiLCBcIj1cIl0pIHJldHVybjtcblx0XHRpZiAodGhpcy5fY3VycmVudEtleXMuc2l6ZSA9PSAwKSByZXR1cm47XG5cdFx0dGhpcy5fY3VycmVudEtleXMuYWRkKGtleSk7XG5cdH1cblx0b25LZXlVcChldmVudDogS2V5Ym9hcmRFdmVudCkge1xuXHRcdGNvbnN0IGtleSA9IGdhbWUua2V5Ym9hcmQuZ2V0S2V5KGV2ZW50KTtcblx0XHRpZiAoa2V5ISBpbiB0aGlzLl9jdXJyZW50S2V5cykgcmV0dXJuO1xuXHRcdGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cdFx0c3dpdGNoIChrZXkpIHtcblx0XHRcdGNhc2UgXCJFbnRlclwiOlxuXHRcdFx0XHRCZXppZXJDb250cm9sLmluc3RhbmNlLmFwcGx5KCk7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0Y2FzZSBcIkRlbGV0ZVwiOlxuXHRcdFx0Y2FzZSBcIkJhY2tzcGFjZVwiOlxuXHRcdFx0XHRCZXppZXJDb250cm9sLmluc3RhbmNlLmNsZWFyVG9vbCgpO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdGNhc2UgXCItXCI6XG5cdFx0XHRcdEJlemllckNvbnRyb2wuaW5zdGFuY2Uuc2VnbWVudHMtLTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlIFwiPVwiOlxuXHRcdFx0XHRCZXppZXJDb250cm9sLmluc3RhbmNlLnNlZ21lbnRzKys7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdH1cblx0XHR0aGlzLl9jdXJyZW50S2V5cy5jbGVhcigpO1xuXHR9XG59XG4iXX0=
